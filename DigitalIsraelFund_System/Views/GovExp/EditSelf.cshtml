@model DigitalIsraelFund_System.Models.UserData
@{
    ViewBag.Title = "עריכה";
}

<style>
   .myInput {
        padding: 2px;
        border-style: solid;
        border-color: #444444;
        border-width: 1px;
        border-radius: 2px;
        border-right-color: #38ACEC;
        border-right-width: 3px;
        border-bottom-right-radius: 0px;
        border-top-right-radius: 0px;
    }
</style>

<div id="cntntDiv" contenteditable="false" style="height:100%;resize:none;overflow-y:auto;min-width:inherit;min-height:200px;border-width:thin;border-style: none;font-family:sans-serif;border-color:#555555;font-size:small;font-weight:400;" dir="rtl">
    <table>
        <tr>
            <td style="padding-left:50px;">
                <table style="padding:10px 5px;border: 0px solid #ccc;margin:auto;">
                    <tr style="background-color:white;border-radius:5px;">
                        <td style="padding:3px;font-weight:600;text-align:right;color:black;border: 0px solid #ccc;border-radius:5px;" colspan="2">
                            <div style="height:10px;border-top-left-radius:5px;border-top-right-radius:10px;background:linear-gradient(to left, #E3E4FA , white);"></div>
                            <div style="padding-right:20px;height:20px;border-top-left-radius:0px;border-top-right-radius:0px;background:linear-gradient(to left, #E3E4FA , white);">
                                עדכון פרטים אישיים
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:3px;font-weight:600;text-align:right;">
                            סיסמה
                        </td>
                        <td style="padding:3px;font-weight:600;text-align:center;">
                            <input id="password" oninput="validate('password', 'Password');" class="form-control" style="border-right-color: #38ACEC;border-right-width: 3px;height:100%;" type="password" />
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:3px;font-weight:600;text-align:right;">
                            שם פרטי
                        </td>
                        <td style="padding:3px;font-weight:600;text-align:center;">
                            <input oninput="validate('firstname', 'Letters')" id="firstname"  class="form-control" style="border-right-color: #38ACEC;border-right-width: 3px;height:100%;width:240px;" type="text" value="@Model.FirstName"/>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:3px;font-weight:600;text-align:right;">
                            שם משפחה
                        </td>
                        <td style="padding:3px;font-weight:600;text-align:center;">
                            <input oninput="validate('lastname', 'Letters')" id="lastname" class="form-control" style="border-right-color: #38ACEC;border-right-width: 3px;height:100%;" type="text" value="@Model.LastName"/>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:3px;font-weight:600;text-align:right;">
                            אימייל
                        </td>
                        <td style="padding:3px;font-weight:600;text-align:center;">
                            <input oninput="validate('email','Email')" id="email"  class="form-control" style="border-right-color: #38ACEC;border-right-width: 3px;height:100%;" type="email" value="@Model.Email"/>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:3px;font-weight:600;text-align:right;">
                            טלפון
                        </td>
                        <td style="padding:3px;font-weight:600;text-align:center;">
                            <input oninput="validate('phone', 'Phone')" id="phone" class="form-control" style="border-right-color: #38ACEC;border-right-width: 3px;height:100%;" type="tel" value="@Model.Phone" />
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:3px;font-weight:600;text-align:right;">
                            פלפון
                        </td>
                        <td style="padding:3px;font-weight:600;text-align:center;">
                            <input oninput="validate('cell_phone', 'Phone')" id="cell_phone" class="form-control" style="border-right-color: #38ACEC;border-right-width: 3px;height:100%;" type="tel" value="@Model.CellPhone" />
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:3px;font-weight:600;text-align:right;">
                            משרד
                        </td>
                        <td style="padding:3px;font-weight:600;text-align:center;">
                            <select id="office" class="form-control" style="height:100%;">
                                @{ 
                                    List<Dictionary<string, string>> offices = (List<Dictionary<string, string>>)ViewData["offices"];
                                    foreach (Dictionary<string, string> office in offices)
                                    {
                                        var selected = office["office_name"] == Model.Office ? "selected" : "";
                                        <option value="@office["id"]" @selected>@office["office_name"]</option>
                                    }
                                }
                            </select>
                        </td>
                    </tr>
                    <tr style="background-color:white;">
                        <td style="padding:3px;font-weight:600;text-align:left;color:whitesmoke;" colspan="2">
                            <button id="choose" onclick="editPersonal();" class="btn btn-primary btn-xs">עדכן פרטים אישיים</button>
                        </td>
                    </tr>
                </table>
            </td>
            <td style="padding-right:50px;border: 0px solid #ccc;border-right-width:1px;">
                <table style="padding:10px 5px;border: 0px solid #ccc;margin:auto;">
                    <tr style="background-color:white;border-radius:5px;">
                        <td style="padding:3px;font-weight:600;text-align:right;color:black;border: 0px solid #ccc;border-radius:5px;" colspan="2">
                            <div style="height:10px;border-top-left-radius:5px;border-top-right-radius:10px;background:linear-gradient(to left, #F5B041 , white);"></div>
                            <div style="padding-right:20px;height:20px;border-top-left-radius:0px;border-top-right-radius:0px;background:linear-gradient(to left, #F5B041 , white);">
                                שינוי סיסמה
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:3px;font-weight:600;text-align:right;">
                            סיסמה ישנה
                        </td>
                        <td style="padding:3px;font-weight:600;text-align:center;">
                            <input id="pass_old" oninput="validate('pass_old', 'Password');" class="form-control" style="border-right-color: #38ACEC;border-right-width: 3px;height:100%;" type="password" />
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:3px;font-weight:600;text-align:right;">
                            סיסמה חדשה
                        </td>
                        <td style="padding:3px;font-weight:600;text-align:center;">
                            <input oninput="checkIfSame(); validate('pass_new', 'Password');" id="pass_new" class="form-control" style="border-right-color: #38ACEC;border-right-width: 3px;height:100%;" type="password" />
                        </td>
                    </tr>
                    <tr>
                        <td style="padding:3px;font-weight:600;text-align:right;">
                            סיסמה חדשה
                        </td>
                        <td style="padding:3px;font-weight:600;text-align:center;">
                            <input oninput="checkIfSame()" id="pass_new_verify" class="form-control" style="border-right-color: #38ACEC;border-right-width: 3px;height:100%;" type="password" />
                        </td>
                    </tr>
                    <tr style="background-color:white;">
                        <td style="padding:3px;font-weight:600;text-align:left;color:whitesmoke;" colspan="2">
                            <button id="choose" onclick="editPassword();" class="btn btn-warning btn-xs">שנה סיסמה</button>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</div>

<script>
    var regLetters = new RegExp('^([- .,A-Za-z0-9א-ת_\n"]+)$');
    var regEmail = /^(([^<>()\[\]\\.,;:\s@@"]+(\.[^<>()\[\]\\.,;:\s@@"]+)*)|(".+"))@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;

    function checkIfSame() {
        newP1 = document.getElementById('pass_new');
        newP2 = document.getElementById('pass_new_verify');
        if (newP2.value == newP1.value) {
            newP2.style.borderRightColor = '#38ACEC';
        } else {
            newP2.style.borderRightColor = '#ff0000';
        }
    }

    function validate(id, type) {
        var data = {
            "value": document.getElementById(id).value,
            "type": type
        };
        $.ajax({
            url: "/Request/ValidateField",
            type: "POST",
            data: JSON.stringify(data),
            dataType: "json",
            contentType: "application/json",
            success: function (response) {
                if (response.Success) {
                    document.getElementById(id).style.borderRightColor = '#38ACEC';
                }
                else {
                    document.getElementById(id).style.borderRightColor = '#ff0000';
                }
            },
            error: function () {
                alert('Fail!!!');
            }
        });
    }

    function editPersonal() {
        var data = {
            "password": $('#password').val(),
            "fname": $('#firstname').val(),
            "lname": $('#lastname').val(),
            "email": $('#email').val(),
            "office": $('#office').val(),
            "phone": $('#phone').val(),
            "cellPhone": $('#cell_phone').val()
        };
        $.ajax({
            url: "/GovExp/EditPersonalInfo",
            type: "POST",
            data: JSON.stringify(data),
            dataType: "json",
            contentType: "application/json",
            success: function (response) {
                if (response.Success) {
                    alert("פרטים אישיים שונו בהצלחה.");
                    location.reload();
                }
                else {
                    alert(response.ErrMsg);
                }
            },
            error: function () {
                alert('בעיה בשרת');
            }
        });
    }

    function editPassword() {
        var newPass = $('#pass_new').val();
        var newPassVer = $('#pass_new_verify').val();
        if (newPass != newPassVer) {
            alert('הסיסמאות לא תואמות.');
            return;
        }
        var data = {
            "oldPass": $('#pass_old').val(),
            "newPass": $('#pass_new').val()
        };
        $.ajax({
            url: "/GovExp/EditPassword",
            type: "POST",
            data: JSON.stringify(data),
            dataType: "json",
            contentType: "application/json",
            success: function (response) {
                if (response.Success) {
                    alert("סיסמה שונתה בהצלחה.");
                    location.reload();
                }
                else {
                    alert("נכשל");
                }
            },
            error: function () {
                alert('Fail!!!');
            }
        });
    }
</script>