@model DigitalIsraelFund_System.Models.TableResult
@using DigitalIsraelFund_System.Models
@{
    ViewBag.Title = "ניהול מומחים";
}

<style>
    .myInp {
        width: 180px;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 12px;
        background-color: white;
        background-image: url('~/Content/Images/search_icon.png');
        background-position: 10px 10px;
        background-repeat: no-repeat;
        padding: 4px 4px 4px 4px;
        -webkit-transition: width 0.4s ease-in-out;
        transition: width 0.4s ease-in-out;
    }

        .myInp:focus {
            width: 240px;
        }

    .fakeInput {
        border: solid 0px #00A;
        border-radius: 4px;
        border-right-color: #38ACEC;
        border-right-width: 0px;
    }
</style>

<script src="~/Scripts/validation.js"></script>
<script src="~/Scripts/ajaxSubmit.js"></script>

<select hidden id="officesCopy" class="fakeInput">
    @{
        List<Dictionary<string, string>> offices = (List<Dictionary<string, string>>)ViewData["offices"];
        foreach (Dictionary<string, string> office in offices)
        {
            <option class="fakeInput" value="@office["id"]">@office["office_name"]</option>
        }
    }
</select>

<div id="cntntDiv" contenteditable="false" style="height:100%;resize:none;overflow-y:auto;min-width:inherit;min-height:200px;border-width:thin;border-style: none;font-family:sans-serif;border-color:#555555;font-size:small;font-weight:400;" dir="rtl">
    <table style="padding:5px 5px;border: 1px solid #ccc;margin:auto;width:85%;">
        <tr style="background-color:#E3E4FA;">
            <td style="padding:3px;font-weight:600;text-align:center;"></td>
            <td style="padding:3px;font-weight:600;text-align:center;">
                <input style="width:12px;height:12px;" type="image" src="~/Content/Images/search_icon.png"
                       onclick="showSearch('fname', 'שם פרטי')" />
                @Html.ActionLink("שם פרטי", "MomhimManage", "Admin", new { orderBy = "fname",
               isDesc = Model.OrderBy == "fname" ? !Model.isDesc : false, page = Model.Page,
               resultsPerPage = Model.ResultsPerPage, search = Model.Search,
               searchBy = Model.SearchField }, null) @{ if (Model.OrderBy == "fname")
                   { if (!Model.isDesc)
                       { <font>🠟</font> }
                       else
                       { <font>🠝</font> }
                   } }
            </td>
            <td style="padding:3px;font-weight:600;text-align:center;">
                <input style="width:12px;height:12px;" type="image" src="~/Content/Images/search_icon.png"
                       onclick="showSearch('lname', 'שם משפחה')" />
                @Html.ActionLink("שם משפחה", "MomhimManage", "Admin", new {
                orderBy = "lname", isDesc = Model.OrderBy == "lname" ? !Model.isDesc : Model.isDesc, page = Model.Page,
                resultsPerPage = Model.ResultsPerPage, search = Model.Search,
               searchBy = Model.SearchField }, null) @{ if (Model.OrderBy == "lname")
                    {
                        if (!Model.isDesc)
                        { <font>🠟</font> }
                        else
                        { <font>🠝</font> }
                    } }
            </td>
            <td style="padding:3px;font-weight:600;text-align:center;">
                <input style="width:12px;height:12px;" type="image" src="~/Content/Images/search_icon.png"
                       onclick="showSearch('email', 'אימייל')" />
                @Html.ActionLink("אימייל", "MomhimManage", "Admin", new
                           {
                                orderBy = "email",
                                isDesc = Model.OrderBy == "email" ? !Model.isDesc : Model.isDesc,
                                page = Model.Page,
                                resultsPerPage = Model.ResultsPerPage, search = Model.Search,
                                searchBy = Model.SearchField
                           }, null) @{ if (Model.OrderBy == "email")
                               {
                                   if (!Model.isDesc)
                                   { <font>🠟</font> }
                                   else
                                   { <font>🠝</font> }
                               } }
            </td>
            <td style="padding:3px;font-weight:600;text-align:center;">
                <input style="width:12px;height:12px;" type="image" src="~/Content/Images/search_icon.png"
                       onclick="showSearch('office_name', 'משרד')" />
                @Html.ActionLink("משרד", "MomhimManage", "Admin", new
               {
                   orderBy = "office_name",
                   isDesc = Model.OrderBy == "office_name" ? !Model.isDesc : Model.isDesc,
                   page = Model.Page,
                   resultsPerPage = Model.ResultsPerPage,
                   search = Model.Search,
                   searchBy = Model.SearchField
               }, null) @{ if (Model.OrderBy == "office_name")
                   {
                       if (!Model.isDesc)
                       { <font>🠟</font> }
                       else
                       { <font>🠝</font> }
                   } }
            </td>
            <td style="padding:3px;font-weight:600;text-align:center;">טלפון</td>
            <td style="padding:3px;font-weight:600;text-align:center;">פלפון</td>
            <td style="padding:3px;font-weight:600;text-align:center;"></td>
            <td style="padding:3px;font-weight:600;text-align:center;"></td>
        </tr>
        <tr style="border: 1px solid #ccc;background-color:darkseagreen;">
            <td colspan="2" style="align-items:flex-start">
                @Html.ActionLink("הוסף מומחה חדש", "AddNewMomhee", "Admin", null, new { @class = "btn btn-primary btn-xs" })
            </td>
            <td colspan="7" style="align-items:flex-start;align-items:center;vertical-align:central;">
                @{
                    var hidden = "";
                    var dict = new Dictionary<string, string>();
                    dict["fname"] = "שם פרטי";
                    dict["lname"] = "שם משפחה";
                    dict["email"] = "אימייל";
                    dict["office_name"] = "משרד";
                    if (Model.SearchField == null)
                    {
                        hidden = "hidden";
                    }
                }
                <div id="searchDiv" @hidden style="float:right;">
                    <font>חיפוש לפי</font>&nbsp;<font style="font-weight:600;" id="searchByTxt">@(Model.SearchField!=null?dict[Model.SearchField]:"")</font>
                    &nbsp;<input id="searchVal" type="search" value="@Model.Search" list="listOptions" placeholder="חיפוש" class="myInp" oninput="updateSearchOptions()" onkeypress="searchAttempt(event)" />
                    <input style="width:16px;height:16px;vertical-align:central;margin:6px;float:right" type="image" src="~/Content/Images/delete_icon.png" onclick="hideSearch();" />
                    <input type="hidden" id="searchBy" value="@Model.SearchField" />
                </div>
                <datalist id="listOptions"></datalist>
            </td>
        </tr>
        @{ var count = (Model.Page - 1) * Model.ResultsPerPage + 1; }
        @foreach (Dictionary<string, string> line in Model.Table)
        {
            <tr style="border: 1px solid #ccc;">
                <td style="padding:3px;border: 0px solid #888;text-align:center;">@(count++)</td>
                <td style="padding:3px;border: 0px solid #888;text-align:center;">
                    <div id="fname_@line["id"]" contenteditable="false" oninput="validateText('fname_@line["id"]','Letters');" class="fakeInput">@line["fname"]</div>
                </td>
                <td style="padding:3px;border: 0px solid #888;text-align:center;">
                    <div id="lname_@line["id"]" contenteditable="false" oninput="validateText('lname_@line["id"]','Letters');" class="fakeInput">@line["lname"]</div>
                </td>
                <td style="padding:3px;border: 0px solid #888;text-align:center;">
                    <div id="email_@line["id"]" contenteditable="false" oninput="validateText('email_@line["id"]','Email');" class="fakeInput">@line["email"]</div>
                </td>
                <td style="padding:3px;border: 0px solid #888;text-align:center;">
                    <div id="office_name_div_@line["id"]">@line["office_name"]</div>
                </td>
                <td style="padding:3px;border: 0px solid #888;text-align:center;">
                    <div id="phone_@line["id"]" contenteditable="false" oninput="validateText('phone_@line["id"]','Phone');" class="fakeInput">@line["phone"]</div>
                </td>
                <td style="padding:3px;border: 0px solid #888;text-align:center;">
                    <div id="cell_phone_@line["id"]" contenteditable="false" oninput="validateText('cell_phone_@line["id"]','Phone');" class="fakeInput">@line["cell_phone"]</div>
                </td>
                <td style="padding:3px;border: 0px solid #888;text-align:center;">
                    @Html.ActionLink("בקשות מקושרות", "ViewRequestsForMomhee", "Admin", new { govExpId = line["id"] }, new { @class = "btn btn-info btn-xs" })
                </td>
                <td style="padding:3px;border: 0px solid #888;text-align:center;">
                    <button id="edit_@line["id"]" class="btn btn-warning btn-xs" onclick="showEdit('@line["id"]');">עריכה</button>
                </td>
            </tr>
        }
        <tr>
            <td colspan="4" style="direction:rtl;background:linear-gradient(to left, #E3E4FA , white);">
                &nbsp;&nbsp;
                <font>תוצאות לעמוד : </font>&nbsp;
                <select id="selectPP" onchange="changeResultsPerPage()">
                    @for (int i = 1; i <= 5; ++i)
                    {
                        if (i * 10 == Model.ResultsPerPage)
                        {
                            <option selected value="@(i*10)">@(i*10)</option>
                        }
                        else
                        {
                            <option value="@(i*10)">@(i * 10)</option>
                        }
                    }
                </select>
                &nbsp;&nbsp;
                @if (Model.NumPages <= 7)
                {
                    for (int i = 1; i <= Model.NumPages; ++i)
                    {
                        if (Model.Page != i)
                        {
                        @Html.ActionLink(i + "", "MomhimManage", "Admin", new {
                                           orderBy = Model.OrderBy,
                                           isDesc = Model.isDesc,
                                           page = i,
                                           resultsPerPage = Model.ResultsPerPage }, null)
                        <font>&nbsp;</font>
                        }
                        else
                        {
                            <font style="font-size:small;color:darkgrey;">@i</font><font>&nbsp;</font>
                        }
                    }
                }
            </td>
        </tr>
    </table>
</div>

<script>

    function showEdit(user_id) {
        var btn = document.getElementById('edit_' + user_id);
        if (btn.innerText != 'שמור') {
            var fields = ['fname_', 'lname_', 'email_', 'phone_', 'cell_phone_'];
            for (i = 0; i < fields.length; ++i) {
                document.getElementById(fields[i] + user_id).style.borderWidth = '1px';
                document.getElementById(fields[i] + user_id).style.borderRightWidth = '3px';
                document.getElementById(fields[i] + user_id).contentEditable = true;
            }

            selectHTML = document.getElementById('officesCopy').innerHTML;
            div = document.getElementById('office_name_div_' + user_id);
            selected = div.innerText;
            div.innerText = "";
            select = document.createElement('select');
            select.id = 'office_' + user_id;
            select.innerHTML = selectHTML;
            for (i = 0; i < select.getElementsByTagName('option').length; i++) {
                child = select.getElementsByTagName('option')[i];
                if (child.innerText == selected) {
                    select.value = child.value;
                    break;
                }
            }
            div.appendChild(select);
            btn.innerText = 'שמור';
            btn.className = 'btn btn-success btn-xs';
        } else {
            var data = {
                "id" : user_id,
                "fname": document.getElementById('fname_' + user_id).innerText,
                "lname": document.getElementById('lname_' + user_id).innerText,
                "email": document.getElementById('email_' + user_id).innerText,
                "office": document.getElementById('office_' + user_id).value,
                "phone": document.getElementById('phone_' + user_id).innerText,
                "cellPhone": document.getElementById('cell_phone_' + user_id).innerText
            };
            ajaxSbmt(data, '/Admin/EditMomhee',
                function (response) {
                    location.reload();
                },
                function (msg) { alert(msg); });
        }
    }

    function changeResultsPerPage() {
        var pp = document.getElementById('selectPP').value;
        window.location.href = "/Admin/MomhimManage?isDesc=@Model.isDesc&page=1&resultsPerPage=" + pp
                        + "&search=@Model.Search&searchBy=@Model.SearchField";
    }

    function updateSearchOptions() {
        var data = {
            "searchVal": document.getElementById('searchVal').value,
            "searchBy": document.getElementById('searchBy').value
        };
        ajaxSbmt(data, '/Admin/SearchUserBy',
            function (response) {
                var options = '';
                $.each(response.List, function (index, item) {
                    options += '<option value="' + item + '" />';
                });
                document.getElementById('listOptions').innerHTML = options;
            },
            function (msg) { });
    }

    function showSearch(searchBy, title) {
        $('#searchDiv').fadeIn(400);
        document.getElementById('searchByTxt').innerText = title;
        document.getElementById('searchBy').value = searchBy;
        document.getElementById('searchVal').value = "";
    }

    function hideSearch() {
        $('#searchDiv').fadeOut(400);
        @if (Model.SearchField != null)
        {
            <text>window.location.href = "/Admin/MomhimManage?isDesc=@Model.isDesc&page=1&resultsPerPage=@Model.ResultsPerPage";</text>
        }
    }

    function searchAttempt(event) {
        if (event.keyCode == 13) {
            window.location.href = "/Admin/MomhimManage?isDesc=@Model.isDesc&page=1&resultsPerPage=@Model.ResultsPerPage"
                        + "&search=" + document.getElementById('searchVal').value
                        + "&searchBy=" + document.getElementById('searchBy').value;
        }
    }

</script>