@model DigitalIsraelFund_System.Models.TableResult
@using DigitalIsraelFund_System.Models
@{
    ViewBag.Title = "ניהול בקשות";

    UserData user = (UserData)Session["user"];
    var type = user != null ? user.Type.ToLower() : "";
}

<style>
    .myInp {
        width: 70%;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 12px;
        background-color: white;
        background-image: url('~/Content/Images/search_icon.png');
        background-position: 10px 10px;
        background-repeat: no-repeat;
        padding: 3px 3px 3px 3px;
        -webkit-transition: width 0.4s ease-in-out;
        transition: width 0.4s ease-in-out;
    }

        .myInp:focus {
            width: 85%;
        }

    .fakeInput {
        border: solid 0px #00A;
        border-radius: 4px;
        border-right-color: #38ACEC;
        border-right-width: 0px;
        min-width: 50px;
        display: inline-block;
        white-space: nowrap;
    }

    .xBtn {
        background-color: #f44336;
        border: none;
        color: white;
        padding: 2px 6px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 10px;
        border-radius: 4px;
    }
</style>

<script src="~/Scripts/validation.js"></script>
<script src="~/Scripts/ajaxSubmit.js"></script>


@helper SearchAbleCol(string fieldName, string fieldTitle, bool isSearchable, bool isOrderable)
{
    <td style="padding:3px;font-size:small;font-weight:600;text-align:center;">
        @if (isSearchable)
        {
            <img style="width:12px;height:12px;" src="~/Content/Images/search_icon.png" />
        }
        @if (isOrderable)
        {
            @Html.ActionLink(fieldTitle, "MomhimManage", "Admin", new
       {
           orderBy = fieldName,
           isDesc = Model.OrderBy == fieldName ? !Model.isDesc : Model.isDesc,
           page = Model.Page,
           resultsPerPage = Model.ResultsPerPage,
           search = Model.Search,
           searchBy = Model.SearchField
       }, null)
            if (Model.OrderBy == fieldName)
            {
                if (!Model.isDesc)
                { <font>🠟</font> }
                else
                { <font>🠝</font> }
            }
        }
        else
        {
            <text>@fieldTitle</text>
        }
        @if (isSearchable)
        {
            <datalist id="listOptions_@fieldName"></datalist>
            <div class="input-group" style="width:100%;overflow-wrap:unset;direction:ltr">
                <span class="input-group-addon" style="background-color:#EC7063;color:white;cursor:pointer;" onclick="clearSearch('@fieldName');">x</span>
                <input id="searchVal_@fieldName" type="search" value="@Request.Params.Get(fieldName)" list="listOptions_@fieldName" placeholder="חיפוש"
                       class="form-control" style="height:100%;" oninput="updateSearchOptions('@fieldName')" onkeypress="searchAttempt(event);" />
            </div>
            <!-- <button class="btn btn-warning btn-xs" style="border-radius:4px;margin-right:-6px;background-color:#EC7063;" onclick="clearSearch('@fieldName');">x</button> -->
        }
    </td>
}

@helper numbersRow()
{
    <tr>
        <td colspan="4" style="direction:rtl;background:linear-gradient(to left, #E3E4FA , white);">
            &nbsp;&nbsp;
            <font>תוצאות לעמוד : </font>&nbsp;
            <select id="selectPP" onchange="changeResultsPerPage()">
                @for (int i = 1; i <= 5; ++i)
                {
                    if (i * 10 == Model.ResultsPerPage)
                    {
                        <option selected value="@(i*10)">@(i * 10)</option>
                    }
                    else
                    {
                        <option value="@(i*10)">@(i * 10)</option>
                    }
                }
            </select>
            &nbsp;&nbsp;
            @if (Model.NumPages <= 7)
            {
                for (int i = 1; i <= Model.NumPages; ++i)
                {
                    if (Model.Page != i)
                    {
                        @Html.ActionLink(i + "", "MomhimManage", "Admin", new
                   {
                       orderBy = Model.OrderBy,
                       isDesc = Model.isDesc,
                       page = i,
                       resultsPerPage = Model.ResultsPerPage
                   }, null)
                        <font>&nbsp;</font>
                    }
                    else
                    {
                        <font style="font-size:small;color:darkgrey;">@i</font><font>&nbsp;</font>
                    }
                }
            }
        </td>
    </tr>
}

<div id="cntntDiv" contenteditable="false" style="height:100%;resize:none;overflow-y:auto;min-width:inherit;min-height:200px;border-width:thin;border-style: none;font-family:sans-serif;border-color:#555555;font-size:small;font-weight:400;" dir="rtl">
    <table style="padding:5px 5px;border: 1px solid #ccc;margin:auto;width:100%;">
        <tr style="background-color:#E3E4FA;">
            <td style="padding:3px;font-weight:600;text-align:center;vertical-align:bottom;"></td>
            @SearchAbleCol("file_number", "מספר תיק", true, true)
            @SearchAbleCol("comp_name", "שם  חברה או היזם", true, true)
            @SearchAbleCol("status", "סטטוס התיק", true, true)
            @SearchAbleCol("submiter_name", "שם  המגיש", true, true)
            @if (type == "admin")
            {
                @SearchAbleCol("momhee_name", "בודק של הרשות לחדשנות", true, true)
            }
            @SearchAbleCol("fund_request", "גובה במענק המבוקש", false, false)
            @SearchAbleCol("madaan_momhee", "בודק משרדי", true, true)
            <td style="padding:3px;font-weight:600;text-align:center;"></td>
            @if (type == "momhee") { <td></td> }
        </tr>
        @{ var count = (Model.Page - 1) * Model.ResultsPerPage + 1; }
        @foreach (Dictionary<string, string> line in Model.Table)
        {
            <tr style="border: 1px solid #ccc;">
                <td style="padding:3px;border: 0px solid #888;text-align:center;">@(count++)</td>
                <td style="padding:3px;border: 0px solid #888;text-align:center;">@line["file_number"]</td>
                <td style="padding:3px;border: 0px solid #888;text-align:center;">@line["comp_name"]</td>
                <td style="padding:3px;border: 0px solid #888;text-align:center;">@line["status"]</td>
                <td style="padding:3px;border: 0px solid #888;text-align:center;">@line["submiter_name"]</td>
                @if (type == "admin")
                {
                    <td style="padding:3px;border: 0px solid #888;text-align:center;">
                        @{
                            if (line["momhee_name"] == "")
                            {
                                @Html.ActionLink("צרף מומחה", "MomhimManage", "Admin", new { file_number = line["file_number"] }, new { @class = "btn btn-primary btn-xs" })
                            }
                            else
                            {
                                @line["momhee_name"]
                            }
                        }
                    </td>
                }
                <td style="padding:3px;border: 0px solid #888;text-align:center;">@line["fund_request"]</td>
                <td style="padding:3px;border: 0px solid #888;text-align:center;">@line["madaan_momhee"]</td>
                <td style="padding:3px;border: 0px solid #888;text-align:center;">
                    <button id="files_@line["file_number"]" class="btn btn-info btn-xs" onclick="showFiles('@line["file_number"]');">קבצים</button>
                </td>
                @if (type == "momhee")
                {
                    <td style="padding:3px;border: 0px solid #888;text-align:center;">
                        @Html.ActionLink("צרף משוב", "AddMashov", "GovExp", new { file_number = line["file_number"] }, new { @class = "btn btn-primary btn-xs" })
                    </td>
                }
            </tr>
        }
        @numbersRow()
    </table>
</div>

<script>

    function changeResultsPerPage() {
        var pp = document.getElementById('selectPP').value;
        window.location.href = "/Admin/MomhimManage?isDesc=@Model.isDesc&page=1&resultsPerPage=" + pp
                        + "&search=@Model.Search&searchBy=@Model.SearchField";
    }

    function updateSearchOptions(field) {
        var data = {
            "searchVal": document.getElementById('searchVal_' + field).value,
            "searchBy": field
        };
        ajaxSbmt(data, '/Admin/SearchRequestBy',
            function (response) {
                var options = '';
                $.each(response.List, function (index, item) {
                    options += '<option value="' + item + '" />';
                });
                document.getElementById('listOptions_' + field).innerHTML = options;
            },
            function (msg) { });
    }

    function searchAttempt(event) {
        if (event.keyCode == 13) {
            reload();
        }
    }

    function clearSearch(fieldName) {
        document.getElementById('searchVal_' + fieldName).value = '';
        reload();
    }

    function reload() {
        var momh_name = document.getElementById('searchVal_momhee_name');
        var add = "";
        if (momh_name != null)
            add = "&momhee_name=" + momh_name.value;
        window.location.href = "/Admin/RequestsManage?isDesc=@Model.isDesc&orderBy=@Model.OrderBy" +
                        "&page=1&resultsPerPage=@Model.ResultsPerPage" +
                        "&file_number=" + document.getElementById('searchVal_file_number').value +
                        "&comp_name=" + document.getElementById('searchVal_comp_name').value +
                        "&status=" + document.getElementById('searchVal_status').value +
                        "&madaan_momhee=" + document.getElementById('searchVal_madaan_momhee').value +
                        "&submiter_name=" + document.getElementById('searchVal_submiter_name').value +
                        add;
    }

</script>